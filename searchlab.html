<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VVStudios - AI Search Lab (Proxy Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: #0f1115; color: white; font-family: 'Inter', sans-serif; }
        .result-card { background: #1a1d23; border: 1px solid #2b2f3a; transition: all 0.3s; }
        .match-glow { border-color: #a855f7; box-shadow: 0 0 20px rgba(168, 85, 247, 0.2); transform: scale(1.02); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Hide scrollbar for cleaner look */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1a1d23; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    </style>
</head>
<body class="p-8 max-w-6xl mx-auto">
    <div class="mb-10 text-center">
        <h1 class="text-3xl font-bold text-purple-400">AI Search Lab v1.1</h1>
        <p class="text-gray-400">Status: <span class="text-green-500 font-mono">Bypassing CORS via Edge Proxy</span></p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
        <div class="space-y-6">
            <div class="p-6 rounded-2xl bg-[#1a1d23] border border-[#2b2f3a]">
                <h3 class="text-sm font-bold uppercase text-gray-500 mb-4">Step 1: Upload Product Screenshot</h3>
                <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-500 cursor-pointer">
                
                <div class="mt-6 grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <p class="text-[10px] text-gray-500 mb-2 uppercase">Original</p>
                        <div class="aspect-square bg-black/40 rounded-lg flex items-center justify-center overflow-hidden border border-[#2b2f3a]">
                            <img id="preview" class="hidden w-full h-full object-contain">
                            <span id="origPlaceholder" class="text-gray-700 text-xs">No Image</span>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="text-[10px] text-purple-400 mb-2 uppercase font-bold">AI Focus (70% Crop)</p>
                        <div class="aspect-square bg-black/40 rounded-lg flex items-center justify-center overflow-hidden border-2 border-purple-500/30">
                            <canvas id="cropPreview" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>

                <button id="searchBtn" class="w-full mt-6 py-4 bg-purple-600 hover:bg-purple-500 rounded-xl font-bold transition-all shadow-lg shadow-purple-900/40 active:scale-95">
                    Run Vector Search
                </button>
            </div>

            <div id="status" class="p-4 rounded-xl bg-purple-900/10 border border-purple-500/20 text-center text-sm text-purple-300 font-mono italic">
                Ready for testing...
            </div>
        </div>

        <div class="space-y-4">
            <h2 class="text-xl font-semibold flex items-center gap-3">
                Live Matches <span id="matchCount" class="text-xs bg-purple-600/20 px-3 py-1 rounded-full text-purple-400 border border-purple-500/30">0</span>
            </h2>
            <div id="resultsGrid" class="space-y-3 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                <div class="text-gray-600 text-center py-20 border-2 border-dashed border-[#2b2f3a] rounded-2xl">
                    Results will appear after analysis
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://xgtnbxdxbbywvzrttixf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhndG5ieGR4YmJ5d3Z6cnR0aXhmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Nzg5NTAsImV4cCI6MjA3MjA1NDk1MH0.YGk0vFyIJEiSpu5phzV04Mh4lrHBlfYLFtPP_afFtMQ';
        
        // POINT TO YOUR NEW PROXY FUNCTION
        const PROXY_URL = `${SUPABASE_URL}/functions/v1/vector-proxy`;
        const businessId = "kisasacraft66"; 

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 1. HANDLE IMAGE SELECTION & CROP ---
        document.getElementById('imageInput').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById('preview');
                    document.getElementById('origPlaceholder').classList.add('hidden');
                    img.onload = () => {
                        img.classList.remove('hidden');
                        applySmartCrop(img);
                    }
                    img.src = ev.target.result;
                }
                reader.readAsDataURL(file);
            }
        };

        function applySmartCrop(imgElement) {
            const canvas = document.getElementById('cropPreview');
            const ctx = canvas.getContext('2d');
            
            // Match the Python 70% Center Crop Logic
            const cropPercent = 0.70; 
            const sourceW = imgElement.naturalWidth;
            const sourceH = imgElement.naturalHeight;
            const cropW = sourceW * cropPercent;
            const cropH = sourceH * cropPercent;
            const startX = (sourceW - cropW) / 2;
            const startY = (sourceH - cropH) / 2;

            canvas.width = 224; // CLIP Standard Input Size
            canvas.height = 224;
            ctx.drawImage(imgElement, startX, startY, cropW, cropH, 0, 0, 224, 224);
        }

        // --- 2. SEARCH VIA PROXY ---
        // Compress canvas to small CLIP-friendly JPEG (target ~30KB)
        async function getCompressedDataURL(sourceCanvas, targetKB = 30) {
            // Ensure 224x224 input
            const w = 224, h = 224;
            const tmp = document.createElement('canvas');
            tmp.width = w; tmp.height = h;
            const tctx = tmp.getContext('2d');
            tctx.drawImage(sourceCanvas, 0, 0, w, h);

            // Try progressively lower qualities until under target size
            let quality = 0.8;
            let dataUrl = tmp.toDataURL('image/jpeg', quality);
            // Approximate binary size from base64 length: 3/4 of chars
            while ((dataUrl.length * 3 / 4) > targetKB * 1024 && quality > 0.2) {
                quality = Math.max(0.2, quality - 0.1);
                dataUrl = tmp.toDataURL('image/jpeg', quality);
            }
            return dataUrl;
        }

        document.getElementById('searchBtn').onclick = async () => {
            const status = document.getElementById('status');
            const grid = document.getElementById('resultsGrid');
            const canvas = document.getElementById('cropPreview');
            
            if (!document.getElementById('preview').src) return alert("Please select an image first!");

            try {
                // A. GET EMBEDDING FROM PROXY
                status.innerText = "‚è≥ Proxy: Calling Railway via Deno...";
                
                // Get a compressed, CLIP-friendly 224x224 JPEG as small as possible
                const base64Data = await getCompressedDataURL(canvas, 30);

                const vecRes = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}` 
                    },
                    body: JSON.stringify({ image_base64: base64Data }) 
                });

                if (!vecRes.ok) {
                    const errorMsg = await vecRes.text();
                    throw new Error(`Proxy Error: ${errorMsg}`);
                }

                const { embedding } = await vecRes.json();
                console.log("Vector Received from Proxy:", embedding);

                // B. QUERY DATABASE (RPC)
                status.innerText = "üîé DB: Matching via match_image_products_v1...";
                
                const { data: products, error } = await supabaseClient.rpc('match_image_products_v1', {
                    query_embedding: embedding,       
                    match_threshold: 0.5,             
                    match_count: 10,                   
                    filter_business_id: businessId    
                });

                if (error) {
                    console.error("RPC Error Details:", error);
                    throw new Error(`Database Error: ${error.message}`);
                }

                // C. RENDER RESULTS
                grid.innerHTML = '';
                document.getElementById('matchCount').innerText = products ? products.length : 0;

                if (!products || products.length === 0) {
                    grid.innerHTML = `
                        <div class="text-gray-500 text-center py-20 border-2 border-dashed border-[#2b2f3a] rounded-2xl">
                            No products matched this image.<br>Try adjusting the 0.5 threshold.
                        </div>`;
                    status.innerText = "‚úÖ Analysis Complete (No Matches).";
                    return;
                }

                products.forEach((item, i) => {
                    // Note: RPC returns 'similarity' (0 to 1), not 'cosine_distance'
                    const sim = (item.similarity * 100).toFixed(1); 
                    const isTop = i === 0;
                    
                    const displayImage = (Array.isArray(item.images) && item.images.length > 0) 
                        ? item.images[0] 
                        : 'https://via.placeholder.com/150';
                    
                    // Construct Link
                    const productLink = item.handle 
                        ? `https://kisasacraft.co.ke/products/${item.handle}` 
                        : `https://kisasacraft.co.ke/products/${item.id}`;

                    grid.innerHTML += `
                        <div class="result-card p-4 rounded-xl flex gap-4 items-center animate-fade-in ${isTop ? 'match-glow border-purple-500/50' : ''}">
                            <div class="relative">
                                <img src="${displayImage}" class="w-20 h-20 object-cover rounded-lg bg-black border border-[#2b2f3a]">
                                ${isTop ? '<span class="absolute -top-2 -left-2 bg-purple-600 text-[8px] font-bold px-2 py-1 rounded-full shadow-lg">BEST</span>' : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-sm truncate text-white">${item.title}</div>
                                <div class="text-xs text-green-400 mt-1 font-mono">${sim}% Match</div>
                                <div class="text-[10px] text-gray-500 mt-1 truncate">${item.id}</div>
                            </div>
                            <a href="${productLink}" target="_blank" class="bg-purple-600/20 hover:bg-purple-600 text-purple-400 hover:text-white px-4 py-2 rounded-lg text-xs font-bold transition-all">
                                VIEW
                            </a>
                        </div>
                    `;
                });

                status.innerText = "‚úÖ Analysis Complete.";

            } catch (err) {
                console.error("Lab Error:", err);
                status.innerText = "‚ùå Error: " + err.message;
            }
        };
    </script>
</body>
</html>