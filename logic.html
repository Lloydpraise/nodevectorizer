<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Headless Vectorizer</title>
</head>
<body>
    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.1';

        // 1. Configure Environment
        env.allowLocalModels = false;
        env.useBrowserCache = true;

        let aiExtractor = null;

        // 2. Your Exact Compression Logic (Refactored for Headless)
        async function compressImage(imageUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; 
                img.src = imageUrl;
                
                img.onload = () => {
                    const canvas = document.createElement('canvas'); // Create in memory
                    const ctx = canvas.getContext('2d');
                    
                    const MAX_WIDTH = 300; 
                    const scaleSize = MAX_WIDTH / img.width;
                    const newWidth = (img.width > MAX_WIDTH) ? MAX_WIDTH : img.width;
                    const newHeight = (img.width > MAX_WIDTH) ? (img.height * scaleSize) : img.height;

                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    // Return Base64
                    resolve(canvas.toDataURL("image/jpeg", 0.8));
                };
                
                img.onerror = (err) => reject("Image Load Failed: " + err);
            });
        }

        // 3. The Main Function exposed to Server
        window.getEmbedding = async (imageUrl) => {
            try {
                // A. Load Model (Lazy load)
                if (!aiExtractor) {
                    console.log("Loading Model...");
                    aiExtractor = await pipeline('feature-extraction', 'Xenova/clip-vit-base-patch32', { 
                        quantized: true 
                    });
                }

                // B. Compress & Resize (Your logic)
                console.log("Compressing...");
                const dataUrl = await compressImage(imageUrl);

                // C. Vectorize
                console.log("Vectorizing...");
                const output = await aiExtractor(dataUrl);
                
                // Return simple array
                return Array.from(output.data);

            } catch (error) {
                return { error: error.message };
            }
        };
    </script>
</body>
</html>